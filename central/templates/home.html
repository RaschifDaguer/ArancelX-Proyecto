{%extends 'base.html'%}
{% load custom_filters %}
{%block content%}
<div class="d-flex justify-content-end mb-3">
    <form method="post" action="/accounts/logout/">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">
            <i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión
        </button>
    </form>
</div>
<div class="container py-5">
    <div class="row mb-4">
        <div class="col text-center">
            <h2 class="fw-bold">¡Bienvenido{{ user.first_name|default:'@'|add:user.username }}!</h2>
            <p class="lead">Este es tu panel principal del Sistema de Aranceles.</p>
        </div>
    </div>
    <div class="row justify-content-center mb-4">
        <div class="col-md-8 position-relative">
            <form class="d-flex" method="get" action="{% url 'arancel:buscador_global' %}">
                <input class="form-control me-2" type="search" id="busqueda-dashboard" name="q" placeholder="Buscar código o descripción..." aria-label="Buscar" aria-autocomplete="list" aria-expanded="false" role="combobox" aria-owns="sugerencias-dashboard" autocomplete="off" required>
                <button class="search-btn-custom" type="submit" aria-label="Buscar"><i class="fas fa-arrow-right"></i></button>
            </form>
            <ul id="sugerencias-dashboard" class="list-group position-absolute w-100" style="z-index: 1000;" role="listbox" aria-label="Sugerencias de búsqueda"></ul>
        </div>
    </div>
    
    <!-- Estadísticas del Sistema -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-10">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card text-center border-primary">
                        <div class="card-body">
                            <i class="fas fa-layer-group fa-2x text-primary mb-2"></i>
                            <h4 class="text-primary">{{ total_secciones }}</h4>
                            <p class="card-text">Secciones</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center border-success">
                        <div class="card-body">
                            <i class="fas fa-book fa-2x text-success mb-2"></i>
                            <h4 class="text-success">{{ total_capitulos }}</h4>
                            <p class="card-text">Capítulos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center border-warning">
                        <div class="card-body">
                            <i class="fas fa-list-ol fa-2x text-warning mb-2"></i>
                            <h4 class="text-warning">{{ total_partidas }}</h4>
                            <p class="card-text">Partidas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center border-info">
                        <div class="card-body">
                            <i class="fas fa-table fa-2x text-info mb-2"></i>
                            <h4 class="text-info">{{ total_subpartidas }}</h4>
                            <p class="card-text">Subpartidas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row justify-content-center mt-4">
        <div class="col-md-8 text-center">
            <a href="{% url 'arancel:tabla_aranceles' %}" class="btn btn-primary btn-lg me-2 mb-2">
                <i class="fas fa-table me-2"></i>Ver Tabla de Aranceles
            </a>
            <a href="{% url 'arancel:seccion_list' %}" class="btn btn-outline-primary btn-lg mb-2">
                <i class="fas fa-layer-group me-2"></i>Ver Secciones
            </a>
            <a href="{% url 'admin_redirect' %}" class="btn btn-outline-dark btn-lg mb-2 ms-2">
                <i class="fas fa-user-shield me-2"></i>Administración
            </a>
        </div>
    </div>
    
    <!-- Gestión de Usuarios y Roles (solo para superusuarios o usuarios con permisos) -->
    {% if user.is_superuser or user.perfil.rol.permisos_usuarios %}
    <div class="row justify-content-center mt-4">
        <div class="col-md-8">
            <div class="card shadow-sm border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-user-cog me-2"></i>
                        Gestión de Usuarios y Roles
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <a href="{% url 'gestionar_usuarios' %}" class="btn btn-warning w-100">
                                <i class="fas fa-users me-2"></i>Gestionar Usuarios
                            </a>
                        </div>
                        <div class="col-md-6 mb-2">
                            <a href="{% url 'gestionar_roles' %}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-user-tag me-2"></i>Gestionar Roles
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Historial de Búsquedas -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Historial de Búsquedas Recientes
                    </h5>
                    {% if historial_busquedas %}
                    <form method="post" action="{% url 'limpiar_historial' %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-light btn-sm" onclick="return confirm('¿Estás seguro de que quieres limpiar todo el historial?')">
                            <i class="fas fa-trash me-1"></i> Limpiar Historial
                        </button>
                    </form>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if historial_busquedas %}
                        <div class="list-group list-group-flush">
                            {% for busqueda in historial_busquedas %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-primary me-2">
                                        {% if busqueda.tipo_resultado == 'Sección' %}
                                            <i class="fas fa-layer-group"></i>
                                        {% elif busqueda.tipo_resultado == 'Capítulo' %}
                                            <i class="fas fa-book"></i>
                                        {% elif busqueda.tipo_resultado == 'Partida' %}
                                            <i class="fas fa-list-ol"></i>
                                        {% elif busqueda.tipo_resultado == 'Subpartida' %}
                                            <i class="fas fa-table"></i>
                                        {% else %}
                                            <i class="fas fa-search"></i>
                                        {% endif %}
                                    </span>
                                    <div>
                                        <strong>{{ busqueda.termino_busqueda }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ busqueda.tipo_resultado|replace_none }} • {{ busqueda.fecha_busqueda|date:"d/m/Y H:i" }}
                                        </small>
                                    </div>
                                </div>
                                {% if busqueda.tipo_resultado != 'Sin resultado' and busqueda.id_resultado %}
                                    <a href="{{ busqueda.tipo_resultado|get_detail_url:busqueda.id_resultado }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i> Ver
                                    </a>
                                {% else %}
                                    <span class="text-muted">Sin resultado</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>No hay búsquedas recientes</p>
                            <small>Realiza tu primera búsqueda para ver el historial aquí</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Autocompletado AJAX para dashboard
const inputDashboard = document.getElementById('busqueda-dashboard');
const sugerenciasDashboard = document.getElementById('sugerencias-dashboard');
let indiceSeleccionado = -1;

inputDashboard.addEventListener('input', function() {
    indiceSeleccionado = -1;
    const valor = this.value.trim();
    if (valor.length < 1) {
        sugerenciasDashboard.innerHTML = '';
        sugerenciasDashboard.style.display = 'none';
        inputDashboard.setAttribute('aria-expanded', 'false');
        return;
    }
    fetch('/arancel/autocomplete/?q=' + encodeURIComponent(valor))
        .then(resp => resp.json())
        .then(data => {
            sugerenciasDashboard.innerHTML = '';
            if (data.length === 0) {
                // Mostrar mensaje de "No se encontró nada"
                const li = document.createElement('li');
                li.className = 'list-group-item text-center text-muted py-3';
                li.innerHTML = '<i class="fas fa-search me-2"></i>No se encontraron coincidencias. Intenta con otros términos.';
                sugerenciasDashboard.appendChild(li);
                sugerenciasDashboard.style.display = 'block';
                return;
            }
            data.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action d-flex align-items-center';
                li.style.cursor = 'pointer';
                li.style.transition = 'background-color 0.2s';
                li.setAttribute('role', 'option');
                li.setAttribute('tabindex', '-1');
                
                // Estilos hover
                li.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                li.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
                
                // Crear contenedor para el badge
                const badgeContainer = document.createElement('div');
                badgeContainer.className = 'd-flex flex-column align-items-center me-3';
                
                // Crear badge de tipo con color distintivo
                const badge = document.createElement('span');
                badge.className = 'badge';
                
                if (item.tipo === 'Partida') {
                    badge.className += ' bg-warning text-dark';
                    badge.innerHTML = '<i class="fas fa-list-ol"></i> P';
                } else if (item.tipo === 'Subpartida') {
                    badge.className += ' bg-info';
                    badge.innerHTML = '<i class="fas fa-table"></i> SP';
                } else if (item.tipo === 'Capítulo') {
                    badge.className += ' bg-success';
                    badge.innerHTML = '<i class="fas fa-book"></i> C';
                } else if (item.tipo === 'Sección') {
                    badge.className += ' bg-primary';
                    badge.innerHTML = '<i class="fas fa-layer-group"></i> S';
                }
                
                badgeContainer.appendChild(badge);
                
                // Indicador de corrección
                if (item.es_correccion) {
                    const correccionBadge = document.createElement('span');
                    correccionBadge.className = 'badge bg-danger mt-1';
                    correccionBadge.style.fontSize = '0.65rem';
                    correccionBadge.innerHTML = '<i class="fas fa-lightbulb"></i> Sugerencia';
                    badgeContainer.appendChild(correccionBadge);
                }
                
                li.appendChild(badgeContainer);
                
                // Crear contenido del texto
                const content = document.createElement('div');
                content.className = 'flex-grow-1';
                
                let codigoText = item.codigo || item.nombre;
                let descripcionText = item.descripcion || '';
                
                // Resaltar coincidencias en el código
                if (codigoText.toLowerCase().includes(valor.toLowerCase())) {
                    const regex = new RegExp(`(${valor})`, 'gi');
                    codigoText = codigoText.replace(regex, '<mark>$1</mark>');
                }
                
                let tituloExtra = '';
                if(item.tipo === 'Subpartida' && item.titulo_desc) {
                    tituloExtra = `<br><span style='color: #6c757d; font-style: italic; font-size: 0.9em;'>→ ${item.titulo_desc}</span>`;
                }
                
                const highlightClass = item.es_correccion ? 'text-primary' : '';
                content.innerHTML = `
                    <div class="${highlightClass}">
                        <strong>${codigoText}</strong>
                        ${descripcionText ? `<br><small style='color: #6c757d;'>${descripcionText}</small>` : ''}
                        ${tituloExtra}
                    </div>
                `;
                li.appendChild(content);
                
                // Click handler
                li.onclick = () => {
                    window.location.href = `/arancel/buscar/?q=${encodeURIComponent(item.codigo || item.nombre)}`;
                };
                
                sugerenciasDashboard.appendChild(li);
            });
            sugerenciasDashboard.style.display = 'block';
            inputDashboard.setAttribute('aria-expanded', 'true');
        });
});
// Prevenir que se cierre al hacer clic en las sugerencias
inputDashboard.addEventListener('blur', function(e) {
    // Verificar si el clic fue fuera del contenedor de sugerencias
    setTimeout(() => {
        if (!sugerenciasDashboard.contains(document.activeElement)) {
            sugerenciasDashboard.innerHTML = '';
            sugerenciasDashboard.style.display = 'none';
        }
    }, 300);
});

// Navegación con teclado
inputDashboard.addEventListener('keydown', function(e) {
    const items = sugerenciasDashboard.querySelectorAll('.list-group-item');
    
    if (e.key === 'Escape') {
        sugerenciasDashboard.innerHTML = '';
        sugerenciasDashboard.style.display = 'none';
        inputDashboard.blur();
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        indiceSeleccionado = (indiceSeleccionado < items.length - 1) ? indiceSeleccionado + 1 : indiceSeleccionado;
        items.forEach((item, index) => {
            item.style.backgroundColor = index === indiceSeleccionado ? '#e9ecef' : '';
        });
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        indiceSeleccionado = (indiceSeleccionado > 0) ? indiceSeleccionado - 1 : -1;
        items.forEach((item, index) => {
            item.style.backgroundColor = index === indiceSeleccionado ? '#e9ecef' : '';
        });
    } else if (e.key === 'Enter' && indiceSeleccionado >= 0 && items[indiceSeleccionado]) {
        e.preventDefault();
        items[indiceSeleccionado].click();
    }
});
</script>
{%endblock%}